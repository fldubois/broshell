<!DOCTYPE html>
<html>
  <head>
    <title></title>
  </head>
  <style>

  @keyframes blink {
    0%   { color: inherit;       }
    49%  { color: inherit;       }
    50%  { color: rgba(0,0,0,0); }
    100% { color: rgba(0,0,0,0); }
  }

  html, body {
    width: 100%;
    margin: 0 3px;
    background-color: rgb(39, 40, 34);
    color: rgb(248, 248, 242);
    font-family: 'Consolas';
  }

  .user         { color: rgb(138, 222, 53); }
  .cwd, .symbol { color: rgb(52, 226, 213); }

  .line.error {
    color: rgb(231, 76, 60);
  }

  .hidden {
    display: none;
  }

  .cursor {
    animation-duration: 1s;
    animation-name: blink;
    animation-iteration-count: infinite;
  }
  </style>
<body>
  <div id="output"></div>
  <div id="input" class="line hidden">
    <span class="prompt"></span><span id="cmd"></span><span class="cursor">&#9608;</span>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    function createPrompt(context) {
      var user = document.createElement('span');
      user.classList.add('user');
      user.innerHTML = context.username + '@' + context.hostname;

      var cwd = document.createElement('span');
      cwd.classList.add('cwd');
      cwd.innerHTML = context.cwd;

      var symbol = document.createElement('span');
      symbol.classList.add('symbol');
      symbol.innerHTML = context.username === 'root' ? '#' : '$';

      var prompt = document.createElement('span');
      prompt.classList.add('prompt');

      prompt.appendChild(user);
      prompt.appendChild(document.createTextNode(' '));
      prompt.appendChild(cwd);
      prompt.appendChild(document.createTextNode(' '));
      prompt.appendChild(symbol);
      prompt.appendChild(document.createTextNode(' '));

      return prompt;
    }

    var output = document.querySelector('#output');
    var input  = document.querySelector('#input');
    var cmd    = document.querySelector('#cmd');

    var context = {};

    console.log('Connecting to ', window.location.host);
    var socket = io.connect(window.location.host);

    socket.on('stdout', function (line) {
      var div = document.createElement('div');
      div.classList.add('line');
      div.innerHTML = line;

      output.appendChild(div);

      // Scroll to bottom
      window.scrollTo(0, document.body.scrollHeight);
    });

    socket.on('stderr', function (line) {
      var div = document.createElement('div');
      div.classList.add('line');
      div.classList.add('error');
      div.innerHTML = line;

      output.appendChild(div);

      // Scroll to bottom
      window.scrollTo(0, document.body.scrollHeight);
    });

    socket.on('context', function (ctx) {
      context = ctx;
      input.replaceChild(createPrompt(context), input.firstChild);
      input.classList.remove('hidden');

      // Scroll to bottom
      window.scrollTo(0, document.body.scrollHeight);
    });

    socket.on('exit', function (code) {
      console.log('exit', code);
    });

    document.body.addEventListener('keypress', function (event) {
      if (!input.classList.contains('hidden')) {
        if (event.keyCode === 13) { // Enter
          var command = cmd.innerHTML;

          var div = document.createElement('div');
          div.classList.add('line');
          div.appendChild(createPrompt(context));
          div.appendChild(document.createTextNode(command));

          cmd.innerHTML = '';
          input.classList.add('hidden');

          output.appendChild(div);

          socket.emit('cmd', command);
        } else if (event.keyCode === 8) { // Backspace
          if (cmd.innerHTML.length > 0) {
            cmd.innerHTML = cmd.innerHTML.substring(0, cmd.innerHTML.length - 1);
          }
          event.preventDefault();
        } else if (event.keyCode === 38) { // Arrow Up
          socket.emit('history', -1, function (command) {
            cmd.innerHTML = command;
          });
        } else if (event.keyCode === 40) { // Arrow Down
          socket.emit('history', 1, function (command) {
            cmd.innerHTML = command;
          });
        } else {
          cmd.innerHTML = cmd.innerHTML + event.key;
        }
      }

      // Scroll to bottom
      window.scrollTo(0, document.body.scrollHeight);

      event.stopPropagation();
    }, false);
  </script>
</body>
</html>
